REFACTORING, SECURITY HARDENING, AND SCALING PLAN

This plan aims to reduce technical debt, address critical security vulnerabilities, and prepare the chatbot system for high concurrency and lower latency.

PROPOSED CHANGES

Backend Refactoring & Hardening (app.py)

- CORS Configuration:
  - Install flask-cors.
  - Restrict origins to the specific domain (or * during development with strict production settings).
- Path Traversal Protection:
  - Implementation of a secure_path(filename, base_folder) helper.
  - Usage of werkzeug.utils.secure_filename.
  - Validation that the resolved path is strictly within the documents folder.
- Security Headers & Middleware:
  - Implement a middleware to set Content-Security-Policy (CSP), X-Frame-Options: DENY, and X-Content-Type-Options: nosniff.
- Rate Limiting:
  - Install Flask-Limiter.
  - Apply rate limits to /chat and ALL admin routes (/save-json, etc.) to prevent brute-force attacks.
- Access Control:
  - Implement a require_admin decorator that checks for an X-Admin-Token.
  - Securely store the token in environment variables with a safe fallback.
- Scaling/Concurrency Optimization:
  - SQLite WAL Mode: Enable Write-Ahead Logging to allow multiple readers and a single writer without blocking.
  - Thread-Local DB Connections: Ensure each request gets its own connection to avoid "dread lock" or race conditions.
  - Async Signal Simulation: For long-running tasks like update-vectordb, ensure the UI doesn't hang (use a status polling or background thread).

Frontend Optimization & Hardening

- chat.css (static/css/chat.css):
  - Externalized styles (Completed).

- chat_logic.js (static/js/chat_logic.js):
  - Externalized logic (Completed).
  - XSS Protection:
    - Integrate DOMPurify via CDN in templates/index_chatbot.html.
    - Wrap ALL marked.parse(content) calls with DOMPurify.sanitize(...).
    - Review innerHTML usage and transition to textContent where possible.

- index_chatbot.html (templates/index_chatbot.html):
  - Integrate security libraries and link external assets.

Concurrency Strategy (session_manager.py)

- WAL Mode Enablement: Execute PRAGMA journal_mode=WAL; on DB initialization.
- Cleanup: Remove any remaining file-system based session logic.

VERIFICATION PLAN

Security & Performance Tests

- Path Traversal: Payload ../../app.py must fail.
- XSS: Payload <img src=x onerror=alert(1)> must be sanitized.
- CORS: Verify that requests from unauthorized origins are blocked.
- Concurrency Test: Simulate 10+ concurrent users sending messages to verify SQLite doesn't deadlock.
- Latency Monitoring: Measure response time for message processing before and after WAL/Pooling.

Manual Verification

- Verify JSON editor still works under admin token.
- Verify Markdown rendering still looks correct after sanitization.
