<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Assistant</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Helvetica Neue", Arial, sans-serif;
        background: #f7f7f8;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        color: #353740;
      }
      .container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: row;
        position: relative;
      } /* SIDEBAR */
      .sidebar {
        width: 260px;
        background: #ffffff;
        border-right: 1px solid #e5e5e6;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow: hidden;
        transition: transform 0.3s ease, width 0.3s ease;
        position: relative;
      }
      .sidebar.collapsed {
        transform: translateX(-260px);
        width: 0;
      }
      .sidebar-header {
        padding: 12px 12px;
        border-bottom: 1px solid #e5e5e6;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 60px;
      }
      .new-chat-btn {
        flex: 1;
        padding: 10px 12px;
        background: transparent;
        border: 1px solid #e5e5e6;
        border-radius: 6px;
        color: #353740;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      .new-chat-btn:hover {
        background: #f7f7f8;
        border-color: #d1d5db;
      }
      .new-chat-btn::before {
        content: "+";
        font-size: 18px;
        font-weight: 300;
      }
      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }
      .sidebar-content::-webkit-scrollbar {
        width: 6px;
      }
      .sidebar-content::-webkit-scrollbar-track {
        background: transparent;
      }
      .sidebar-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }
      .sidebar-content::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      .history-section {
        margin-bottom: 16px;
      }
      .history-label {
        font-size: 11px;
        color: #8e8ea0;
        padding: 8px 12px 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .history-item {
        padding: 10px 12px;
        margin: 2px 0;
        background: transparent;
        border-radius: 6px;
        font-size: 14px;
        color: #353740;
        cursor: pointer;
        transition: background 0.2s ease;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
      }
      .history-item:hover {
        background: #f7f7f8;
      } /* MAIN CONTENT */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
        background: #ffffff;
      }
      .header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e5e6;
        background: #ffffff;
        min-height: 60px;
        gap: 12px;
      }
      .sidebar-toggle {
        background: transparent;
        border: none;
        color: #8e8ea0;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 18px;
      }
      .sidebar-toggle:hover {
        background: #f7f7f8;
        color: #353740;
      }
      .header-title {
        font-size: 16px;
        font-weight: 600;
        color: #353740;
      }
      .content {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        display: flex;
        flex-direction: column;
        background: #ffffff;
      }
      .content::-webkit-scrollbar {
        width: 8px;
      }
      .content::-webkit-scrollbar-track {
        background: transparent;
      }
      .content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }
      .content::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      .welcome-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 24px;
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
      }
      .welcome-content.hidden {
        display: none;
      }
      .avatar {
        width: 64px;
        height: 64px;
        margin-bottom: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .greeting-text {
        font-size: 32px;
        font-weight: 600;
        color: #202123;
        margin-bottom: 8px;
        text-align: center;
      }
      .subtitle {
        font-size: 16px;
        color: #6e6e80;
        line-height: 1.5;
        margin-bottom: 16px;
        text-align: center;
      }
      .actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 12px;
        width: 100%;
        max-width: 1200px;
        margin-bottom: 0;
      }
      .actions.hidden {
        display: none;
      }
      .action-card {
        padding: 20px;
        background: #ffffff;
        border: 1px solid #e5e5e6;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        overflow: hidden;
      }
      .action-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #10a37f, #0d8f6e);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
      }
      .action-card:hover {
        background: #fafafa;
        border-color: #10a37f;
        box-shadow: 0 4px 12px rgba(16, 163, 127, 0.08);
        transform: translateY(-2px);
      }
      .action-card:hover::before {
        transform: scaleX(1);
      }
      .action-card:active {
        transform: translateY(0);
      }
      .action-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(16, 163, 127, 0.1) 0%,
          rgba(16, 163, 127, 0.05) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #10a37f;
        flex-shrink: 0;
        transition: all 0.2s ease;
      }
      .action-card:hover .action-icon {
        background: linear-gradient(
          135deg,
          rgba(16, 163, 127, 0.15) 0%,
          rgba(16, 163, 127, 0.1) 100%
        );
        transform: scale(1.05);
      }
      .action-content {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
      }
      .action-content h3 {
        font-size: 15px;
        font-weight: 600;
        color: #202123;
        margin: 0;
        line-height: 1.3;
        letter-spacing: -0.01em;
      }
      .action-content p {
        font-size: 13px;
        color: #6e6e80;
        line-height: 1.5;
        margin: 0;
      }
      .chat-history {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        padding: 16px 24px;
        display: none;
        flex-direction: column;
        gap: 16px;
        flex: 1;
      }
      .chat-history.active {
        display: flex;
      }
      .message {
        display: flex;
        gap: 16px;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
      }
      .message.user .message-avatar {
        background: #10a37f;
      }
      .message.assistant .message-avatar {
        background: #8e8ea0;
      }
      .message-content {
        flex: 1;
        padding-top: 4px;
        font-size: 16px;
        line-height: 1.75;
        color: #353740;
        word-wrap: break-word;
      }
      .message.user {
        flex-direction: row-reverse;
      }
      .message.user .message-content {
        text-align: right;
      }
      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #8e8ea0;
        animation: typing 1.4s infinite;
      }
      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.5;
        }
        30% {
          transform: translateY(-4px);
          opacity: 1;
        }
      }
      .input-area {
        padding: 12px 16px;
        border-top: 1px solid #e5e5e6;
        background: #ffffff;
        display: flex;
        justify-content: center;
      }
      .input-group {
        width: 100%;
        max-width: 900px;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        background: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 24px;
        padding: 8px 12px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      .input-group:focus-within {
        border-color: #10a37f;
        box-shadow: 0 2px 12px rgba(16, 163, 127, 0.15);
      }
      .input-field {
        flex: 1;
        border: none;
        outline: none;
        font-size: 15px;
        font-family: inherit;
        color: #353740;
        background: transparent;
        resize: none;
        max-height: 200px;
        min-height: 20px;
        line-height: 1.5;
        padding: 4px 8px;
      }
      .input-field::placeholder {
        color: #8e8ea0;
      }
      .send-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: #10a37f;
        color: #ffffff;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
        font-size: 14px;
        padding: 0;
        margin-left: 4px;
      }
      .send-btn:hover:not(:disabled) {
        background: #0d8f6e;
        transform: scale(1.05);
      }
      .send-btn:active:not(:disabled) {
        transform: scale(0.95);
      }
      .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      } /* Tutorial/Step Styles */
      .tutorial-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .tutorial-header {
        font-size: 18px;
        font-weight: 600;
        color: #202123;
        margin-bottom: 8px;
      }
      .help-note {
        padding: 12px 16px;
        background: #f0f9ff;
        border-left: 3px solid #10a37f;
        border-radius: 6px;
        font-size: 14px;
        color: #353740;
        margin-bottom: 8px;
      }
      .steps-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 8px;
      }
      .step-item {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .step-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 4px;
      }
      .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #10a37f;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
      }
      .step-text {
        font-size: 16px;
        line-height: 1.6;
        color: #353740;
        flex: 1;
      }
      .step-image {
        width: 100%;
        max-width: 600px;
        border-radius: 8px;
        border: 1px solid #e5e5e6;
        margin-top: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        cursor: zoom-in;
        transition: all 0.3s ease;
      }
      .step-image:hover {
        transform: scale(1.02);
        border-color: #10a37f;
        box-shadow: 0 4px 16px rgba(16, 163, 127, 0.2);
      } /* Capabilities Styles */
      .capabilities-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .capabilities-header {
        text-align: center;
        margin-bottom: 16px;
      }
      .capabilities-title {
        font-size: 24px;
        font-weight: 700;
        color: #202123;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #10a37f, #0d8f6e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .capabilities-subtitle {
        font-size: 16px;
        color: #6e6e80;
        line-height: 1.5;
      }
      .capabilities-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 16px 0;
      }
      .capability-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: flex-start;
        gap: 16px;
        transition: all 0.2s ease;
      }
      .capability-card:hover {
        border-color: #10a37f;
        background: #f0f9ff;
        transform: translateY(-2px);
      }
      .capability-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .capability-info {
        flex: 1;
      }
      .capability-title {
        font-size: 16px;
        font-weight: 600;
        color: #202123;
        margin-bottom: 4px;
      }
      .capability-description {
        font-size: 14px;
        color: #6e6e80;
        line-height: 1.5;
      }
      .capabilities-footer {
        text-align: center;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
        font-size: 14px;
        color: #8e8ea0;
        font-weight: 500;
      }

      .capability-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: #10a37f;
      }
      .capability-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }
      .capability-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(16, 163, 127, 0.1) 0%,
          rgba(16, 163, 127, 0.05) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #10a37f;
        flex-shrink: 0;
      }
      .capability-title {
        font-size: 18px;
        font-weight: 700;
        color: #202123;
        margin: 0;
      }
      .capability-subtitle {
        font-size: 14px;
        color: #6e6e80;
        margin: 4px 0 0 0;
        font-weight: 500;
      }
      .capability-features {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .capability-feature {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 8px 0;
        font-size: 14px;
        color: #4b5563;
        line-height: 1.5;
      }
      .capability-feature::before {
        content: "‚úì";
        color: #10a37f;
        font-weight: bold;
        font-size: 16px;
        margin-top: 2px;
        flex-shrink: 0;
      }
      .capabilities-footer {
        text-align: center;
        padding: 20px 0 0 0;
        border-top: 1px solid #e5e7eb;
        margin-top: 20px;
      }
      .capabilities-cta {
        font-size: 16px;
        font-weight: 600;
        color: #10a37f;
        margin: 0;
      }
      .suggested-actions {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e5e6;
      }
      .suggested-actions-title {
        font-size: 14px;
        font-weight: 600;
        color: #8e8ea0;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .suggested-actions-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .suggested-action-btn {
        padding: 8px 16px;
        background: #ffffff;
        border: 1px solid #e5e5e6;
        border-radius: 6px;
        font-size: 14px;
        color: #353740;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .suggested-action-btn:hover {
        background: #f7f7f8;
        border-color: #10a37f;
        color: #10a37f;
      }
      .completion-message {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e5e5e6;
        font-size: 16px;
        color: #353740;
        line-height: 1.6;
      } /* Image Modal Styles */
      .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        backdrop-filter: blur(10px);
        animation: fadeIn 0.3s ease;
      }
      .image-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        max-width: 90%;
        max-height: 90%;
        border-radius: 12px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        animation: zoomIn 0.3s ease;
      }
      .close-modal {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.1);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1001;
      }
      .close-modal:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }
      /* ===== NEW CAPABILITIES CARD UI ===== */

      .capabilities-wrapper {
        display: flex;
        justify-content: flex-start;
        margin-top: 5px;
      }

      .capabilities-card {
        width: 100%;
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        padding: 20px 22px;
        border-radius: 14px;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
        animation: fadeSlide 0.4s ease-out;
      }

      @keyframes fadeSlide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .scale-in {
        animation: scaleIn 0.3s ease-out;
      }

      @keyframes scaleIn {
        0% {
          transform: scale(0.95);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .cap-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }

      .cap-icon {
        background: rgba(255, 255, 255, 0.15);
        padding: 10px;
        border-radius: 12px;
        font-size: 22px;
      }

      .cap-title {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
      }

      .cap-subtitle {
        margin: 4px 0 0 0;
        opacity: 0.8;
        font-size: 14px;
      }

      .cap-features {
        margin: 15px 0;
      }

      .cap-feature {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 12px;
      }

      .cap-bullet {
        width: 9px;
        height: 9px;
        background: white;
        border-radius: 50%;
        margin-top: 6px;
      }

      .cap-footer {
        margin-top: 14px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.18);
        padding: 8px 12px;
        border-radius: 10px;
        text-align: center;
        font-size: 14px;
      }

      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @media (max-width: 768px) {
        .sidebar {
          position: absolute;
          z-index: 100;
          height: 100%;
          box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }
        .sidebar.collapsed {
          transform: translateX(-100%);
        }
        .actions {
          grid-template-columns: 1fr;
        }
        .welcome-content {
          padding: 24px 16px;
        }
        .greeting-text {
          font-size: 24px;
        }
        .action-card {
          padding: 16px;
        }
        .capabilities-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .capability-card {
          padding: 20px;
        }
        .capability-icon {
          width: 40px;
          height: 40px;
          font-size: 20px;
        }
        .capability-title {
          font-size: 16px;
        }
        .close-modal {
          top: 10px;
          right: 15px;
          width: 40px;
          height: 40px;
          font-size: 30px;
        }
      }

      @media (max-width: 480px) {
        .actions {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .action-card {
          padding: 12px;
        }
        .action-icon {
          width: 32px;
          height: 32px;
          font-size: 16px;
        }
        .action-content h3 {
          font-size: 14px;
        }
        .action-content p {
          font-size: 12px;
        }
        .capability-card {
          padding: 16px;
        }
        .capability-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .capability-title {
          font-size: 15px;
        }
      }

      /* Markdown Styles */
      .markdown-content p {
        margin-bottom: 8px;
      }
      .markdown-content p:last-child {
        margin-bottom: 0;
      }
      .markdown-content strong {
        font-weight: 700;
        color: #202123;
      }
      .markdown-content ul,
      .markdown-content ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }
      .markdown-content li {
        margin-bottom: 4px;
      }
      /* Animation Styles */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
        opacity: 0; /* Start hidden */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- SIDEBAR -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <button class="new-chat-btn" onclick="newChat()">New chat</button>
        </div>
        <div class="sidebar-content" id="sidebarContent">
          <div class="history-section">
            <div class="history-label">Today</div>
            <div class="history-item" onclick="loadHistory(0)">
              Create a data visualization
            </div>
            <div class="history-item" onclick="loadHistory(1)">
              Filter quarterly reports
            </div>
            <div class="history-item" onclick="loadHistory(2)">
              Sort by date range
            </div>
          </div>
          <div class="history-section">
            <div class="history-label">Yesterday</div>
            <div class="history-item" onclick="loadHistory(3)">
              Export data to CSV
            </div>
            <div class="history-item" onclick="loadHistory(4)">
              Create custom fields
            </div>
            <div class="history-item" onclick="loadHistory(5)">
              Merge duplicate entries
            </div>
          </div>
        </div>
      </div>

      <!-- MAIN CONTENT -->
      <div class="main-content">
        <div class="header">
          <button
            class="sidebar-toggle"
            onclick="toggleSidebar()"
            title="Toggle sidebar"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12h18M3 6h18M3 18h18" />
            </svg>
          </button>
          <div class="header-title">Chat Assistant</div>
        </div>

        <div class="content">
          <!-- Welcome Content -->
          <div class="welcome-content" id="welcomeContent">
            <div class="avatar">
              <div style="font-size: 40px">ü§ñ</div>
            </div>

            <div class="greeting-text">How can I help you today?</div>

            <div class="subtitle">
              Let's tackle your data together. Select a prompt or just ask away!
            </div>

            <div class="actions" id="actions">
              <div class="action-card" onclick="selectAction('region')">
                <div class="action-icon">üè¢</div>
                <div class="action-content">
                  <h3>Add New Region</h3>
                  <p>Step-by-step guide to add regions in management portal</p>
                </div>
              </div>

              <div class="action-card" onclick="selectAction('area')">
                <div class="action-icon">üó∫Ô∏è</div>
                <div class="action-content">
                  <h3>Create New Area</h3>
                  <p>Learn how to create and manage areas in the system</p>
                </div>
              </div>

              <div class="action-card" onclick="selectAction('territory')">
                <div class="action-icon">üìç</div>
                <div class="action-content">
                  <h3>Add Territory</h3>
                  <p>Complete tutorial for territory management</p>
                </div>
              </div>

              <div class="action-card" onclick="selectAction('distributor')">
                <div class="action-icon">üöö</div>
                <div class="action-content">
                  <h3>Create Distributor</h3>
                  <p>Set up distributors with all required details</p>
                </div>
              </div>

              <div class="action-card" onclick="selectAction('section')">
                <div class="action-icon">üì¶</div>
                <div class="action-content">
                  <h3>Add Section</h3>
                  <p>Guide to creating and managing sections</p>
                </div>
              </div>

              <div class="action-card" onclick="selectAction('sector')">
                <div class="action-icon">üè≠</div>
                <div class="action-content">
                  <h3>Setup Sector</h3>
                  <p>Learn sector configuration and management</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat History -->
          <div class="chat-history" id="chatHistory"></div>
        </div>

        <div class="input-area">
          <div class="input-group">
            <textarea
              class="input-field"
              id="messageInput"
              placeholder="Message Chat Assistant..."
              onkeypress="handleKeyPress(event)"
              rows="1"
            ></textarea>
            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
      <span class="close-modal" onclick="closeImageModal()">&times;</span>
      <img class="modal-content" id="modalImage" />
    </div>

    <script>
      // API Configuration - Works when served as static template in Flask
      const API_BASE_URL = window.location.origin;
      const API_ENDPOINT = `${API_BASE_URL}/chat`;

      const chatHistory = document.getElementById("chatHistory");
      const messageInput = document.getElementById("messageInput");
      const actions = document.getElementById("actions");
      const welcomeContent = document.getElementById("welcomeContent");
      const sidebar = document.getElementById("sidebar");
      const sendBtn = document.getElementById("sendBtn");
      const imageModal = document.getElementById("imageModal");
      const modalImage = document.getElementById("modalImage");

      // Local in-memory conversation + last tutorial store
      const chatStateHistory = []; // stores "User: ..." and "Assistant: ..." strings
      let lastTutorialSteps = []; // stores last tutorial steps array returned from backend

      function toggleSidebar() {
        sidebar.classList.toggle("collapsed");
      }

      function selectAction(action) {
        const actionTexts = {
          region: "How to add a new region?",
          area: "How to create a new area?",
          territory: "How to add a new territory?",
          distributor: "How to create a distributor?",
          section: "How to add a new section?",
          sector: "How to setup a new sector?",
        };
        messageInput.value = actionTexts[action];
        sendMessage();
      }

      function loadHistory(index) {
        const historyItems = [
          "How to add a new region?",
          "How to create a distributor?",
          "What can you help me with?",
          "How to add a new area?",
          "Steps to create a territory",
          "Guide me through adding sections",
        ];
        messageInput.value = historyItems[index];
        messageInput.focus();
        auto_resize();
      }

      function newChat() {
        chatHistory.innerHTML = "";
        chatStateHistory.length = 0;
        lastTutorialSteps = [];
        chatHistory.classList.remove("active");
        welcomeContent.classList.remove("hidden");
        actions.classList.remove("hidden");
        messageInput.value = "";
        auto_resize();
      }

      // Image Modal Functions
      function openImageModal(imgSrc) {
        modalImage.src = imgSrc;
        imageModal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeImageModal() {
        imageModal.classList.remove("active");
        document.body.style.overflow = "";
      }

      imageModal.addEventListener("click", function (e) {
        if (e.target === imageModal) closeImageModal();
      });

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && imageModal.classList.contains("active")) {
          closeImageModal();
        }
      });

      function addMessage(text, isUser, responseData = null) {
        chatHistory.classList.add("active");
        if (chatHistory.children.length === 0) {
          welcomeContent.classList.add("hidden");
          actions.classList.add("hidden");
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isUser ? "user" : "assistant"}`;

        const avatarDiv = document.createElement("div");
        avatarDiv.className = "message-avatar";
        avatarDiv.textContent = isUser ? "U" : "AI";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        chatHistory.appendChild(messageDiv);

        if (isUser) {
          contentDiv.textContent = text;
          scrollToBottom();
        } else {
          // Assistant Message with Typing Effect
          contentDiv.classList.add("markdown-content");

          // 1. Determine Text Content vs. Complex Content
          let textToType = "";
          let complexHtml = "";

          if (responseData) {
            // Extract main text based on type
            textToType = responseData.content || "";

            // Render the REST of the content (complex parts)
            // We temporarily clear 'content' from data so specific renderers don't duplicate it
            // But we clone it first to avoid mutations if needed
            const dataForRender = { ...responseData, content: null };

            if (responseData.type === "tutorial") {
              complexHtml = renderTutorialResponse(dataForRender);
            } else if (responseData.type === "tutorial_clarify") {
              // For clarify, the 'content' might be part of the flow, but let's separate it
              complexHtml = renderTutorialClarifyResponse(dataForRender);
            } else if (responseData.type === "capabilities") {
              // Capabilities title/content is special, let's keep it as is or handle?
              // Capabilities usually has title + subtitle.
              // Let's type the subtitle (content) and title?
              // Actually, for capabilities, 'content' is the subtitle. 'title' is separate.
              // Let's type the content.
              complexHtml = renderCapabilitiesResponse(dataForRender);
            } else {
              complexHtml = renderRegularResponse(dataForRender);
            }
          } else {
            textToType = text;
          }

          // 2. Start Typing Animation
          if (textToType) {
            typeWriter(contentDiv, textToType, () => {
              // 3. After typing, append Complex Content
              if (complexHtml) {
                const complexDiv = document.createElement("div");
                complexDiv.innerHTML = complexHtml;
                complexDiv.className = "fade-in"; // Add animation class
                contentDiv.appendChild(complexDiv);
                attachEventListeners(complexDiv); // Re-attach listeners to new elements
              }
              scrollToBottom();
            });
          } else if (complexHtml) {
            // No text, just complex content
            contentDiv.innerHTML = complexHtml;
            contentDiv.classList.add("fade-in");
            attachEventListeners(contentDiv);
            scrollToBottom();
          }
        }
      }

      // Typewriter Effect Function
      function typeWriter(element, text, callback) {
        let i = 0;
        const speed = 30; // ms per char (slower for aesthetics)
        const step = 1; // 1 char per frame (smoother)

        // Create a temporary container for the typing text
        const textContainer = document.createElement("div");
        element.appendChild(textContainer);

        function type() {
          if (i < text.length) {
            // Append a chunk of text
            const chunk = text.substring(0, i + step);
            // Parse markdown for the current chunk to keep formatting
            // Note: This can be glitchy with bolding (**), but simple streaming is better than nothing.
            // A smoother way is to just append text and render markdown at the END.
            // But user wants "word by word".
            // Compromise: Update innerHTML with parsed markdown of current substring.
            textContainer.innerHTML = marked.parse(chunk);

            i += step;
            scrollToBottom();
            setTimeout(type, speed);
          } else {
            // Ensure full text is rendered correctly at the end
            textContainer.innerHTML = marked.parse(text);
            if (callback) callback();
          }
        }

        type();
      }

      function attachEventListeners(container) {
        // Re-attach listeners for buttons/images inside the container
        if (!container) return;

        // Suggested Actions
        container.querySelectorAll(".suggested-action-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            selectSuggestedAction(btn.getAttribute("data-action"));
          });
        });

        // Images
        container
          .querySelectorAll(".step-image")
          .forEach((img) =>
            img.addEventListener("click", () => openImageModal(img.src))
          );

        // Clarify Buttons
        container.querySelectorAll(".clarify-step-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const stepNum = btn.getAttribute("data-step");
            messageInput.value = `clarify step ${stepNum}`;
            sendMessage();
          });
        });
      }

      function renderCapabilitiesResponse(data) {
        // Separated Header (title) from typed content
        let html = `
        <div class="capabilities-wrapper">
          <div class="capabilities-container">
            <div class="capabilities-header">
              <h2 class="capabilities-title">${escapeHtml(
                data.title || ""
              )}</h2>
              <!-- Content is typed above, so skipped here -->
            </div>

            <div class="capabilities-grid">
      `;

        if (data.features && data.features.length > 0) {
          data.features.forEach((feature) => {
            html += `
            <div class="capability-card">
              <div class="capability-icon">${feature.icon}</div>
              <div class="capability-info">
                <h3 class="capability-title">${escapeHtml(feature.title)}</h3>
                <p class="capability-description">${escapeHtml(
                  feature.description
                )}</p>
              </div>
            </div>
          `;
          });
        }

        html += `
            </div>
            <div class="capabilities-footer">
              ${escapeHtml(data.footer_cta)}
            </div>
            ${renderSuggestedActions(data.suggested_actions)}
          </div>
        </div>
      `;
        return html;
      }

      function renderTutorialResponse(data) {
        // Content is typed separately
        let html = '<div class="tutorial-content">';

        // Help Note
        if (data.help_note)
          html += `<div class="help-note">${marked.parse(
            data.help_note
          )}</div>`;

        // Steps
        if (data.steps && data.steps.length > 0) {
          html += '<div class="steps-container">';
          data.steps.forEach((step) => {
            html += '<div class="step-item">';
            html += '<div class="step-header">';
            html += `<div class="step-number">${step.step_number}</div>`;
            html += `<div class="step-text">${marked.parse(step.text)}</div>`;
            html += "</div>";
            if (step.image) {
              const imageUrl = step.image.startsWith("http")
                ? step.image
                : `${API_BASE_URL}${step.image}`;
              html += `<img src="${imageUrl}" alt="Step ${step.step_number}" class="step-image" onerror="this.style.display='none'">`;
            }
            html += "</div>";
          });
          html += "</div>";
        }

        // Pro Tip & Completion
        html += `<div class="completion-message"><strong>Pro tip:</strong> ${marked.parse(
          data.pro_tip || ""
        )}</div>`;
        html += `<div class="completion-message">${marked.parse(
          data.completion_message || ""
        )}</div>`;

        html += renderSuggestedActions(data.suggested_actions);
        html += "</div>";
        return html;
      }

      function renderTutorialClarifyResponse(data) {
        const cs = data.clarified_step;
        let html = '<div class="tutorial-content">';
        // Content is typed separately

        html += `<div class="step-item"><div class="step-header"><div class="step-number">${
          cs.step_number
        }</div><div class="step-text">${marked.parse(
          cs.clarified
        )}</div></div>`;
        if (cs.image) {
          const imageUrl = cs.image.startsWith("http")
            ? cs.image
            : `${API_BASE_URL}${cs.image}`;
          html += `<img src="${imageUrl}" alt="Step ${cs.step_number}" class="step-image" onerror="this.style.display='none'">`;
        }
        html += "</div>";
        html += renderSuggestedActions(data.suggested_actions);
        html += "</div>";
        return html;
      }

      function renderRegularResponse(data) {
        let html = "";
        // Content typed separately
        if (data.completion_message)
          html += `<div class="completion-message">${marked.parse(
            data.completion_message
          )}</div>`;
        html += renderSuggestedActions(data.suggested_actions);
        return html;
      }

      function renderSuggestedActions(actions) {
        if (!actions || actions.length === 0) return "";
        let html =
          '<div class="suggested-actions"><div class="suggested-actions-title">Suggested Actions</div><div class="suggested-actions-list">';
        actions.forEach((action) => {
          html += `<button class="suggested-action-btn" data-action="${escapeHtml(
            action
          )}">${escapeHtml(action)}</button>`;
        });
        html += "</div></div>";
        return html;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function selectSuggestedAction(action) {
        messageInput.value = action;
        messageInput.focus();
        auto_resize();
        setTimeout(() => sendMessage(), 100);
      }

      function showTypingIndicator() {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant";
        messageDiv.id = "typing-indicator";

        const avatarDiv = document.createElement("div");
        avatarDiv.className = "message-avatar";
        avatarDiv.textContent = "AI";

        const typingDiv = document.createElement("div");
        typingDiv.className = "message-content";
        typingDiv.innerHTML = `<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(typingDiv);
        chatHistory.appendChild(messageDiv);
        scrollToBottom();
      }

      function removeTypingIndicator() {
        const typing = document.getElementById("typing-indicator");
        if (typing) typing.remove();
      }

      function scrollToBottom() {
        setTimeout(() => {
          const content = document.querySelector(".content");
          if (content) {
            content.scrollTop = content.scrollHeight;
          }
        }, 100);
      }

      // === SEND MESSAGE (includes conversation_history + last_tutorial) ===
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message (UI + local history)
        addMessage(message, true);
        chatStateHistory.push(`User: ${message}`);

        // If this is a "clarify step X" type, we still send lastTutorialSteps so backend can clarify
        const payload = {
          message: message,
          conversation_history: chatStateHistory,
          last_tutorial: lastTutorialSteps,
        };

        messageInput.value = "";
        auto_resize();
        sendBtn.disabled = true;
        showTypingIndicator();

        try {
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          removeTypingIndicator();

          if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
          }

          const data = await response.json();

          // Render assistant response object (data)
          addMessage("", false, data);

          // Update local lastTutorialSteps if backend returned steps
          if (data.type === "tutorial" && Array.isArray(data.steps)) {
            lastTutorialSteps = data.steps;
          }
          // If clarify response, we don't overwrite lastTutorialSteps

          // Build assistantText for local chatStateHistory (short content)
          let assistantText = "";
          if (data.type === "tutorial") {
            assistantText = (data.content || "") + " " + (data.summary || "");
          } else if (data.type === "tutorial_clarify") {
            assistantText = data.clarified_step
              ? data.clarified_step.clarified || ""
              : data.content || "";
          } else {
            assistantText = data.content || "";
          }
          assistantText = assistantText.trim();
          if (assistantText) {
            chatStateHistory.push(`Assistant: ${assistantText}`);
          }

          // If response contains conversation_history from server, sync if longer
          if (Array.isArray(data.conversation_history)) {
            if (data.conversation_history.length >= chatStateHistory.length) {
              chatStateHistory.length = 0;
              data.conversation_history.forEach((item) =>
                chatStateHistory.push(item)
              );
            }
          }
        } catch (err) {
          removeTypingIndicator();
          console.error("Send error:", err);
          addMessage("Sorry, something went wrong. Try again.", false);
        } finally {
          sendBtn.disabled = false;
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      function auto_resize() {
        messageInput.style.height = "auto";
        messageInput.style.height =
          Math.min(messageInput.scrollHeight, 200) + "px";
      }

      messageInput.addEventListener("input", () => {
        auto_resize();
        sendBtn.disabled = !messageInput.value.trim();
      });
    </script>
  </body>
</html>
